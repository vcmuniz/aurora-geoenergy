<div class="releases-container">
  <h1>Releases</h1>

  <div class="toolbar">
    <div class="filters">
      <div class="app-filter">
        <label for="app-filter">Aplica√ß√£o:</label>
        <select 
          id="app-filter"
          [(ngModel)]="filterAppId" 
          (change)="onFilterChange()"
          class="app-dropdown">
          <option value="">Todas as Aplica√ß√µes</option>
          <option *ngFor="let app of applications" [value]="app.id">
            {{ app.name }} - {{ app.ownerTeam }}
          </option>
        </select>
      </div>
      <div class="status-filter">
        <label for="status-filter">Status:</label>
        <select 
          id="status-filter"
          [(ngModel)]="filterStatus" 
          (change)="onFilterChange()"
          class="status-dropdown">
          <option value="ACTIVE">Ativos (Pendentes + Aprovados + Produ√ß√£o)</option>
          <option value="ALL">Todos</option>
          <option value="PENDING">Pendentes</option>
          <option value="APPROVED">Aprovados</option>
          <option value="DEPLOYED">Implantados</option>
          <option value="REJECTED">Rejeitados</option>
        </select>
      </div>
    </div>
    <button (click)="openForm()" *ngIf="canCreate" class="btn-new">+ Novo Release</button>
  </div>

  <div *ngIf="loading" class="loading">Carregando...</div>

  <table *ngIf="!loading && filteredReleases.length > 0" class="table">
    <thead>
      <tr>
        <th>Aplica√ß√£o</th>
        <th>Vers√£o</th>
        <th>Ambiente</th>
        <th>Status</th>
        <th>Score</th>
        <th>Aprova√ß√µes</th>
        <th>Criada em</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let release of paginatedReleases">
        <td>{{ getApplicationName(release.applicationId) }}</td>
        <td><strong>{{ release.version }}</strong></td>
        <td><span [class]="'env-badge env-' + release.env">{{ getEnvLabel(release.env) }}</span></td>
        <td><span [class]="'status-badge status-' + release.status">{{ getStatusLabel(release.status) }}</span></td>
        <td>
          <div class="score-badge">
            <strong>{{ release.evidenceScore }}%</strong>
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="release.evidenceScore"></div>
            </div>
          </div>
        </td>
        <td>
          <div class="approval-counts">
            <span class="approved">‚úì {{ getApprovalCounts(release.id).approved }}</span>
            <span class="rejected">‚úó {{ getApprovalCounts(release.id).rejected }}</span>
          </div>
        </td>
        <td>{{ release.createdAt | date: 'dd/MM/yyyy' }}</td>
        <td>
          <button (click)="viewRelease(release)" class="btn-icon" title="Visualizar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
          </button>
          <button *ngIf="canEdit && release.status !== 'DEPLOYED' && release.status !== 'REJECTED'" (click)="editRelease(release)" class="btn-icon" title="Editar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button *ngIf="canPromote && release.env !== 'PROD' && release.status !== 'REJECTED' && release.status !== 'DEPLOYED'" (click)="openPromoteModal(release.id, release.env)" class="btn-icon" title="Promover">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>
            </svg>
          </button>
          <button *ngIf="canPromote && release.env === 'PROD' && release.status === 'APPROVED'" (click)="deploy(release.id)" class="btn-icon btn-icon-success" title="Implantar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
          </button>
          <button *ngIf="canReject && (release.status === 'PENDING' || release.status === 'APPROVED')" (click)="reject(release.id)" class="btn-icon btn-icon-danger" title="Rejeitar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="!loading && filteredReleases.length === 0" class="empty">
    Nenhum release encontrado
  </div>

  <div *ngIf="!loading && filteredReleases.length > 0" class="pagination">
    <div class="pagination-info">
      <button (click)="previousPage()" [disabled]="!canPrevious" class="btn-nav">‚Üê Anterior</button>
      <span class="page-info">P√°gina {{ (skip / limit) + 1 }} de {{ Math.ceil(total / limit) }}</span>
      <button (click)="nextPage()" [disabled]="!canNext" class="btn-nav">Pr√≥xima ‚Üí</button>
    </div>
    <div class="items-per-page">
      <label>Itens por p√°gina:</label>
      <select [(ngModel)]="limit" (change)="onLimitChange()" [ngModelOptions]="{updateOn: 'change'}" class="select-limit">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
      </select>
    </div>
  </div>

  <!-- Modal Form -->
  <div *ngIf="showForm" class="modal">
    <div class="modal-content">
      <h2>{{ isEditMode ? 'Editar Release' : 'Novo Release' }}</h2>
      <div class="modal-body">
        <form (ngSubmit)="save()">
          <div class="form-group">
            <label>Aplica√ß√£o *</label>
            <select [(ngModel)]="formData.applicationId" name="applicationId" required [disabled]="isEditMode">
              <option value="">-- Selecionar Aplica√ß√£o --</option>
              <option *ngFor="let app of applications" [value]="app.id">
                {{ app.name }} - {{ app.ownerTeam }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Vers√£o *</label>
            <input [(ngModel)]="formData.version" name="version" type="text" required />
          </div>
          <div class="form-group">
            <label>Ambiente *</label>
            <select [(ngModel)]="formData.env" name="env" required [disabled]="!isEditMode">
              <option value="DEV">{{ getEnvLabel('DEV') }}</option>
              <option value="PRE_PROD">{{ getEnvLabel('PRE_PROD') }}</option>
              <option value="PROD">{{ getEnvLabel('PROD') }}</option>
            </select>
            <small *ngIf="!isEditMode" style="color: #7f8c8d; display: block; margin-top: 4px;">Novas releases sempre come√ßam em DEV</small>
          </div>
          <div class="form-group">
            <label>Evidence URL</label>
            <input [(ngModel)]="formData.evidenceUrl" name="evidenceUrl" type="text" />
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn-save">{{ isEditMode ? 'Atualizar' : 'Criar' }}</button>
            <button type="button" (click)="closeForm()" class="btn-cancel">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Release Modal -->
  <div *ngIf="showViewModal && selectedRelease" class="modal" (click)="closeViewModal()">
    <div class="modal-content modal-view-release" (click)="$event.stopPropagation()">
      <button (click)="closeViewModal()" class="btn-close" title="Fechar">‚úï</button>
      <h2>{{ selectedRelease.version }} - {{ getApplicationName(selectedRelease.applicationId) }}</h2>
      
      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab" 
          [class.active]="activeViewTab === 'info'"
          (click)="setViewTab('info')">
          üìã Informa√ß√µes
        </button>
        <button 
          class="tab" 
          [class.active]="activeViewTab === 'approvals'"
          (click)="setViewTab('approvals')">
          ‚úÖ Aprova√ß√µes ({{ selectedReleaseApprovals.length }})
        </button>
        <button 
          class="tab" 
          [class.active]="activeViewTab === 'timeline'"
          (click)="setViewTab('timeline')">
          üïê Timeline
        </button>
      </div>

      <div class="modal-body">
        <!-- Tab: Informa√ß√µes Gerais -->
        <div *ngIf="activeViewTab === 'info'" class="tab-content">
          <div class="detail-grid">
            <div class="detail-row">
              <span class="detail-label">Aplica√ß√£o:</span>
              <span class="detail-value">{{ getApplicationName(selectedRelease.applicationId) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Vers√£o:</span>
              <span class="detail-value"><strong>{{ selectedRelease.version }}</strong></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Ambiente:</span>
              <span class="detail-value">
                <span [class]="'env-badge env-' + selectedRelease.env">{{ getEnvLabel(selectedRelease.env) }}</span>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Status:</span>
              <span class="detail-value">
                <span [class]="'status-badge status-' + selectedRelease.status">{{ getStatusLabel(selectedRelease.status) }}</span>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Score de Evid√™ncia:</span>
              <span class="detail-value">
                <div class="score-display">
                  <strong>{{ selectedRelease.evidenceScore }}%</strong>
                  <div class="score-bar-inline">
                    <div class="score-fill" [style.width.%]="selectedRelease.evidenceScore"></div>
                  </div>
                </div>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Evidence URL:</span>
              <span class="detail-value">
                <a *ngIf="selectedRelease.evidenceUrl" [href]="selectedRelease.evidenceUrl" target="_blank">{{ selectedRelease.evidenceUrl }}</a>
                <span *ngIf="!selectedRelease.evidenceUrl">-</span>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Criada em:</span>
              <span class="detail-value">{{ selectedRelease.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">√öltima atualiza√ß√£o:</span>
              <span class="detail-value">{{ selectedRelease.updatedAt | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </div>

        <!-- Tab: Aprova√ß√µes -->
        <div *ngIf="activeViewTab === 'approvals'" class="tab-content">
          <div *ngIf="loadingApprovals" class="loading-small">Carregando aprova√ß√µes...</div>
          
          <div *ngIf="!loadingApprovals && selectedReleaseApprovals.length === 0" class="empty-small">
            Nenhuma aprova√ß√£o registrada
          </div>

          <div *ngIf="!loadingApprovals && selectedReleaseApprovals.length > 0" class="approvals-list">
            <div *ngFor="let approval of selectedReleaseApprovals" class="approval-item" [class.approved]="approval.outcome === 'APPROVED'" [class.rejected]="approval.outcome === 'REJECTED'">
              <div class="approval-header">
                <span class="approval-icon">{{ approval.outcome === 'APPROVED' ? '‚úì' : '‚úó' }}</span>
                <span class="approval-outcome">{{ approval.outcome === 'APPROVED' ? 'Aprovado' : 'Rejeitado' }}</span>
              </div>
              <div class="approval-details">
                <div><strong>{{ approval.approverEmail }}</strong></div>
                <div class="approval-date">{{ approval.createdAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                <div *ngIf="approval.notes" class="approval-notes">{{ approval.notes }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Timeline -->
        <div *ngIf="activeViewTab === 'timeline'" class="tab-content">
          <app-timeline [events]="timeline"></app-timeline>
        </div>
      </div>
    </div>
  </div>

  <!-- Timeline Modal (standalone - mantido para compatibilidade) -->
  <div *ngIf="selectedReleaseId && !showViewModal" class="modal" (click)="closeTimeline()">
    <div class="modal-content modal-timeline" (click)="$event.stopPropagation()">
      <button (click)="closeTimeline()" class="btn-close" title="Fechar">‚úï</button>
      <h2>Timeline do Release</h2>
      <div class="modal-body">
        <app-timeline [events]="timeline"></app-timeline>
      </div>
    </div>
  </div>

  <!-- Promote Modal -->
  <div *ngIf="showPromoteModal" class="modal" (click)="closePromoteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button (click)="closePromoteModal()" class="btn-close" title="Fechar">‚úï</button>
      <h2>Promover Release</h2>
      <div class="modal-body">
        <p style="color: #7f8c8d; margin-bottom: 20px;">Ambiente atual: <strong style="color: #2c3e50;">{{ getEnvLabel(currentEnv) }}</strong></p>
      <div class="form-group">
        <label>Ambiente Destino:</label>
        <select [(ngModel)]="promoteTargetEnv" name="targetEnv">
          <option *ngIf="currentEnv === 'DEV'" value="PRE_PROD">{{ getEnvLabel('PRE_PROD') }}</option>
          <option *ngIf="currentEnv === 'PRE_PROD'" value="PROD">{{ getEnvLabel('PROD') }}</option>
        </select>
      </div>

      <!-- Valida√ß√£o para PRE_PROD -> PROD -->
      <div *ngIf="currentEnv === 'PRE_PROD' && promoteTargetEnv === 'PROD' && promoteValidation" class="validation-section">
        <h3>Requisitos para Promo√ß√£o:</h3>
        <div class="validation-item" [class.valid]="promoteValidation.hasApprovals" [class.invalid]="!promoteValidation.hasApprovals">
          <span class="icon">{{ promoteValidation.hasApprovals ? '‚úÖ' : '‚ùå' }}</span>
          <span>Aprova√ß√µes: {{ promoteValidation.approvalCount }}/{{ promoteValidation.minApprovals || 1 }} necess√°ria(s)</span>
        </div>
        <div class="validation-item" [class.valid]="promoteValidation.hasEvidenceUrl" [class.invalid]="!promoteValidation.hasEvidenceUrl">
          <span class="icon">{{ promoteValidation.hasEvidenceUrl ? '‚úÖ' : '‚ùå' }}</span>
          <span>Evidence URL: {{ promoteValidation.evidenceUrl ? 'Presente' : 'Faltando' }}</span>
        </div>
        <div class="validation-item" [class.valid]="promoteValidation.hasMinScore" [class.invalid]="!promoteValidation.hasMinScore">
          <span class="icon">{{ promoteValidation.hasMinScore ? '‚úÖ' : '‚ùå' }}</span>
          <span>Score: {{ promoteValidation.score }}/{{ promoteValidation.minScore }} m√≠nimo</span>
        </div>
        <div class="validation-item" [class.valid]="!promoteValidation.isFrozen" [class.invalid]="promoteValidation.isFrozen">
          <span class="icon">{{ !promoteValidation.isFrozen ? '‚úÖ' : '‚ùå' }}</span>
          <span>Freeze Window: {{ promoteValidation.isFrozen ? promoteValidation.freezeMessage : 'Permitido' }}</span>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="promoteRelease()" [disabled]="currentEnv === 'PRE_PROD' && promoteTargetEnv === 'PROD' && promoteValidation && !promoteValidation.canPromote" class="btn-save">Promover</button>
        <button (click)="closePromoteModal()" class="btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div *ngIf="showRejectModal" class="modal" (click)="closeRejectModal()">
  <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
    <button (click)="closeRejectModal()" class="btn-close" title="Fechar">‚úï</button>
    <div class="modal-icon modal-icon-danger">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </div>
    <h2>Rejeitar Release</h2>
    <div class="modal-body">
      <p class="modal-description">Tem certeza que deseja rejeitar esta release?</p>
      <div class="form-group">
        <label>Motivo da rejei√ß√£o (opcional):</label>
        <textarea [(ngModel)]="rejectNotes" name="rejectNotes" rows="3" placeholder="Descreva o motivo da rejei√ß√£o..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button (click)="confirmReject()" class="btn-danger">Rejeitar</button>
      <button (click)="closeRejectModal()" class="btn-cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Deploy Modal -->
<div *ngIf="showDeployModal" class="modal" (click)="closeDeployModal()">
  <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
    <button (click)="closeDeployModal()" class="btn-close" title="Fechar">‚úï</button>
    <div class="modal-icon modal-icon-success">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
      </svg>
    </div>
    <h2>Implantar em Produ√ß√£o</h2>
    <div class="modal-body">
      <p class="modal-description">Confirma a implanta√ß√£o desta release em produ√ß√£o?</p>
      <p class="modal-warning">‚ö†Ô∏è Esta a√ß√£o ir√° marcar a release como implantada.</p>
    </div>
    <div class="modal-actions">
      <button (click)="confirmDeploy()" class="btn-success">Implantar</button>
      <button (click)="closeDeployModal()" class="btn-cancel">Cancelar</button>
    </div>
  </div>
</div>
