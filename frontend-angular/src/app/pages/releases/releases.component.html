<div class="releases-container">
  <h1>Releases</h1>

  <div class="toolbar">
    <div class="filters">
      <div class="app-filter">
        <label for="app-filter">Aplicação:</label>
        <select 
          id="app-filter"
          [(ngModel)]="filterAppId" 
          (change)="onFilterChange()"
          class="app-dropdown">
          <option value="">Todas as Aplicações</option>
          <option *ngFor="let app of applications" [value]="app.id">
            {{ app.name }} - {{ app.ownerTeam }}
          </option>
        </select>
      </div>
      <div class="status-filter">
        <label for="status-filter">Status:</label>
        <select 
          id="status-filter"
          [(ngModel)]="filterStatus" 
          (change)="onFilterChange()"
          class="status-dropdown">
          <option value="ACTIVE">Ativos (Pendentes + Aprovados + Produção)</option>
          <option value="ALL">Todos</option>
          <option value="PENDING">Pendentes</option>
          <option value="APPROVED">Aprovados</option>
          <option value="DEPLOYED">Implantados</option>
          <option value="REJECTED">Rejeitados</option>
        </select>
      </div>
    </div>
    <button (click)="openForm()" [disabled]="!canCreate" class="btn-new">+ Novo Release</button>
  </div>

  <div *ngIf="loading" class="loading">Carregando...</div>

  <table *ngIf="!loading && filteredReleases.length > 0" class="table">
    <thead>
      <tr>
        <th>Aplicação</th>
        <th>Versão</th>
        <th>Ambiente</th>
        <th>Status</th>
        <th>Score</th>
        <th>Aprovações</th>
        <th>Criada em</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let release of paginatedReleases">
        <td>{{ getApplicationName(release.applicationId) }}</td>
        <td><strong>{{ release.version }}</strong></td>
        <td><span [class]="'env-badge env-' + release.env">{{ getEnvLabel(release.env) }}</span></td>
        <td><span [class]="'status-badge status-' + release.status">{{ getStatusLabel(release.status) }}</span></td>
        <td>
          <div class="score-badge">
            <strong>{{ release.evidenceScore }}%</strong>
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="release.evidenceScore"></div>
            </div>
          </div>
        </td>
        <td>
          <div class="approval-counts">
            <span class="approved">✓ {{ getApprovalCounts(release.id).approved }}</span>
            <span class="rejected">✗ {{ getApprovalCounts(release.id).rejected }}</span>
          </div>
        </td>
        <td>{{ release.createdAt | date: 'dd/MM/yyyy' }}</td>
        <td>
          <button (click)="loadTimeline(release.id)" class="btn-icon" title="Timeline">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </button>
          <button *ngIf="release.status !== 'DEPLOYED' && release.status !== 'REJECTED'" (click)="editRelease(release)" [disabled]="!canEdit" class="btn-icon" title="Editar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button *ngIf="release.env !== 'PROD' && release.status !== 'REJECTED' && release.status !== 'DEPLOYED'" (click)="openPromoteModal(release.id, release.env)" [disabled]="!canPromote" class="btn-icon" title="Promover">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>
            </svg>
          </button>
          <button *ngIf="release.env === 'PROD' && release.status === 'APPROVED'" (click)="deploy(release.id)" class="btn-icon btn-icon-success" title="Implantar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
          </button>
          <button *ngIf="release.status === 'PENDING' || release.status === 'APPROVED'" (click)="reject(release.id)" class="btn-icon btn-icon-danger" title="Rejeitar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="!loading && filteredReleases.length === 0" class="empty">
    Nenhum release encontrado
  </div>

  <div *ngIf="!loading && filteredReleases.length > 0" class="pagination">
    <div class="pagination-info">
      <button (click)="previousPage()" [disabled]="!canPrevious" class="btn-nav">← Anterior</button>
      <span class="page-info">Página {{ (skip / limit) + 1 }} de {{ Math.ceil(total / limit) }}</span>
      <button (click)="nextPage()" [disabled]="!canNext" class="btn-nav">Próxima →</button>
    </div>
    <div class="items-per-page">
      <label>Itens por página:</label>
      <select [(ngModel)]="limit" (change)="onLimitChange()" [ngModelOptions]="{updateOn: 'change'}" class="select-limit">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
      </select>
    </div>
  </div>

  <!-- Modal Form -->
  <div *ngIf="showForm" class="modal">
    <div class="modal-content">
      <h2>{{ isEditMode ? 'Editar Release' : 'Novo Release' }}</h2>
      <div class="modal-body">
        <form (ngSubmit)="save()">
          <div class="form-group">
            <label>Aplicação *</label>
            <select [(ngModel)]="formData.applicationId" name="applicationId" required [disabled]="isEditMode">
              <option value="">-- Selecionar Aplicação --</option>
              <option *ngFor="let app of applications" [value]="app.id">
                {{ app.name }} - {{ app.ownerTeam }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Versão *</label>
            <input [(ngModel)]="formData.version" name="version" type="text" required />
          </div>
          <div class="form-group">
            <label>Ambiente *</label>
            <select [(ngModel)]="formData.env" name="env" required [disabled]="!isEditMode">
              <option value="DEV">DEV</option>
              <option value="PRE_PROD">PRE_PROD</option>
              <option value="PROD">PROD</option>
            </select>
            <small *ngIf="!isEditMode" style="color: #7f8c8d; display: block; margin-top: 4px;">Novas releases sempre começam em DEV</small>
          </div>
          <div class="form-group">
            <label>Evidence URL</label>
            <input [(ngModel)]="formData.evidenceUrl" name="evidenceUrl" type="text" />
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn-save">{{ isEditMode ? 'Atualizar' : 'Criar' }}</button>
            <button type="button" (click)="closeForm()" class="btn-cancel">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Timeline Modal -->
  <div *ngIf="selectedReleaseId" class="modal" (click)="closeTimeline()">
    <div class="modal-content modal-timeline" (click)="$event.stopPropagation()">
      <button (click)="closeTimeline()" class="btn-close" title="Fechar">✕</button>
      <h2>Timeline do Release</h2>
      <div class="modal-body">
        <app-timeline [events]="timeline"></app-timeline>
      </div>
    </div>
  </div>

  <!-- Promote Modal -->
  <div *ngIf="showPromoteModal" class="modal" (click)="closePromoteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button (click)="closePromoteModal()" class="btn-close" title="Fechar">✕</button>
      <h2>Promover Release</h2>
      <div class="modal-body">
        <p style="color: #7f8c8d; margin-bottom: 20px;">Ambiente atual: <strong style="color: #2c3e50;">{{ currentEnv }}</strong></p>
      <div class="form-group">
        <label>Ambiente Destino:</label>
        <select [(ngModel)]="promoteTargetEnv" name="targetEnv">
          <option *ngIf="currentEnv === 'DEV'" value="PRE_PROD">PRE_PROD</option>
          <option *ngIf="currentEnv === 'PRE_PROD'" value="PROD">PROD</option>
        </select>
      </div>

      <!-- Validação para PRE_PROD -> PROD -->
      <div *ngIf="currentEnv === 'PRE_PROD' && promoteTargetEnv === 'PROD' && promoteValidation" class="validation-section">
        <h3>Requisitos para Promoção:</h3>
        <div class="validation-item" [class.valid]="promoteValidation.hasApprovals" [class.invalid]="!promoteValidation.hasApprovals">
          <span class="icon">{{ promoteValidation.hasApprovals ? '✅' : '❌' }}</span>
          <span>Aprovações: {{ promoteValidation.approvalCount }}/{{ promoteValidation.minApprovals || 1 }} necessária(s)</span>
        </div>
        <div class="validation-item" [class.valid]="promoteValidation.hasEvidenceUrl" [class.invalid]="!promoteValidation.hasEvidenceUrl">
          <span class="icon">{{ promoteValidation.hasEvidenceUrl ? '✅' : '❌' }}</span>
          <span>Evidence URL: {{ promoteValidation.evidenceUrl ? 'Presente' : 'Faltando' }}</span>
        </div>
        <div class="validation-item" [class.valid]="promoteValidation.hasMinScore" [class.invalid]="!promoteValidation.hasMinScore">
          <span class="icon">{{ promoteValidation.hasMinScore ? '✅' : '❌' }}</span>
          <span>Score: {{ promoteValidation.score }}/{{ promoteValidation.minScore }} mínimo</span>
        </div>
        <div class="validation-item" [class.valid]="!promoteValidation.isFrozen" [class.invalid]="promoteValidation.isFrozen">
          <span class="icon">{{ !promoteValidation.isFrozen ? '✅' : '❌' }}</span>
          <span>Freeze Window: {{ promoteValidation.isFrozen ? promoteValidation.freezeMessage : 'Permitido' }}</span>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="promoteRelease()" [disabled]="currentEnv === 'PRE_PROD' && promoteTargetEnv === 'PROD' && promoteValidation && !promoteValidation.canPromote" class="btn-save">Promover</button>
        <button (click)="closePromoteModal()" class="btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div *ngIf="showRejectModal" class="modal" (click)="closeRejectModal()">
  <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
    <button (click)="closeRejectModal()" class="btn-close" title="Fechar">✕</button>
    <div class="modal-icon modal-icon-danger">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </div>
    <h2>Rejeitar Release</h2>
    <div class="modal-body">
      <p class="modal-description">Tem certeza que deseja rejeitar esta release?</p>
      <div class="form-group">
        <label>Motivo da rejeição (opcional):</label>
        <textarea [(ngModel)]="rejectNotes" name="rejectNotes" rows="3" placeholder="Descreva o motivo da rejeição..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button (click)="confirmReject()" class="btn-danger">Rejeitar</button>
      <button (click)="closeRejectModal()" class="btn-cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Deploy Modal -->
<div *ngIf="showDeployModal" class="modal" (click)="closeDeployModal()">
  <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
    <button (click)="closeDeployModal()" class="btn-close" title="Fechar">✕</button>
    <div class="modal-icon modal-icon-success">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
      </svg>
    </div>
    <h2>Implantar em Produção</h2>
    <div class="modal-body">
      <p class="modal-description">Confirma a implantação desta release em produção?</p>
      <p class="modal-warning">⚠️ Esta ação irá marcar a release como implantada.</p>
    </div>
    <div class="modal-actions">
      <button (click)="confirmDeploy()" class="btn-success">Implantar</button>
      <button (click)="closeDeployModal()" class="btn-cancel">Cancelar</button>
    </div>
  </div>
</div>
