<div class="releases-container">
  <h1>Releases</h1>

  <div class="app-selector">
    <label for="app-dropdown">Selecione Aplicação:</label>
    <select 
      id="app-dropdown"
      [(ngModel)]="selectedAppId" 
      (change)="onAppChange()"
      class="app-dropdown">
      <option value="">-- Escolher Aplicação --</option>
      <option *ngFor="let app of applications" [value]="app.id">
        {{ app.name }} - {{ app.ownerTeam }}
      </option>
    </select>
  </div>

  <button *ngIf="selectedAppId" (click)="openForm()" [disabled]="!canCreate" class="btn-new">+ Novo Release</button>

  <div *ngIf="loading" class="loading">Carregando...</div>

  <table *ngIf="!loading && releases.length > 0" class="table">
    <thead>
      <tr>
        <th>Versão</th>
        <th>Ambiente</th>
        <th>Status</th>
        <th>Score</th>
        <th>Aprovações</th>
        <th>Criada em</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let release of releases">
        <td>{{ release.version }}</td>
        <td>{{ release.env }}</td>
        <td><span [class]="'status-' + release.status">{{ release.status }}</span></td>
        <td>
          <div class="score-badge">
            <strong>{{ release.evidenceScore }}%</strong>
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="release.evidenceScore"></div>
            </div>
          </div>
        </td>
        <td>
          <div class="approval-counts">
            <span class="approved">✓ {{ getApprovalCounts(release.id).approved }}</span>
            <span class="rejected">✗ {{ getApprovalCounts(release.id).rejected }}</span>
          </div>
        </td>
        <td>{{ release.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <button (click)="loadTimeline(release.id)" class="btn-timeline">Timeline</button>
          <button *ngIf="release.env !== 'PROD'" (click)="editRelease(release)" [disabled]="!canEdit" class="btn-edit">Editar</button>
          <button *ngIf="release.env !== 'PROD'" (click)="openPromoteModal(release.id, release.env)" [disabled]="!canPromote" class="btn-promote">Promover</button>
          <button *ngIf="release.env !== 'PROD'" (click)="delete(release.id)" [disabled]="!canDelete" class="btn-delete">Deletar</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="!loading && releases.length === 0 && selectedAppId" class="empty">
    Nenhum release encontrado
  </div>

  <div *ngIf="selectedAppId" class="pagination">
    <div class="pagination-info">
      <button (click)="previousPage()" [disabled]="!canPrevious" class="btn-nav">← Anterior</button>
      <span class="page-info">Página {{ (skip / limit) + 1 }} de {{ Math.ceil(total / limit) }}</span>
      <button (click)="nextPage()" [disabled]="!canNext" class="btn-nav">Próxima →</button>
    </div>
    <div class="items-per-page">
      <label>Itens por página:</label>
      <select [(ngModel)]="limit" (change)="onLimitChange()" [ngModelOptions]="{updateOn: 'change'}" class="select-limit">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
      </select>
    </div>
  </div>

  <!-- Modal Form -->
  <div *ngIf="showForm" class="modal">
    <div class="modal-content">
      <h2>{{ isEditMode ? 'Editar Release' : 'Novo Release' }}</h2>
      <form (ngSubmit)="save()">
        <div class="form-group">
          <label>Versão *</label>
          <input [(ngModel)]="formData.version" name="version" type="text" required />
        </div>
        <div class="form-group">
          <label>Ambiente *</label>
          <select [(ngModel)]="formData.env" name="env" required>
            <option value="DEV">DEV</option>
            <option value="PRE_PROD">PRE_PROD</option>
            <option value="PROD">PROD</option>
          </select>
        </div>
        <div class="form-group">
          <label>Evidence URL</label>
          <input [(ngModel)]="formData.evidenceUrl" name="evidenceUrl" type="text" />
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-save">{{ isEditMode ? 'Atualizar' : 'Criar' }}</button>
          <button type="button" (click)="closeForm()" class="btn-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Timeline Modal -->
  <div *ngIf="selectedReleaseId" class="modal" (click)="closeTimeline()">
    <div class="modal-content modal-timeline" (click)="$event.stopPropagation()">
      <h2>Timeline do Release</h2>
      <button (click)="closeTimeline()" class="btn-close" title="Fechar">✕</button>
      <app-timeline [events]="timeline"></app-timeline>
    </div>
  </div>

  <!-- Promote Modal -->
  <div *ngIf="showPromoteModal" class="modal" (click)="closePromoteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Promover Release</h2>
      <button (click)="closePromoteModal()" class="btn-close" title="Fechar">✕</button>
      <p style="color: #7f8c8d; margin-bottom: 20px;">Ambiente atual: <strong style="color: #2c3e50;">{{ currentEnv }}</strong></p>
      <div class="form-group">
        <label>Ambiente Destino:</label>
        <select [(ngModel)]="promoteTargetEnv" name="targetEnv">
          <option *ngIf="currentEnv === 'DEV'" value="PRE_PROD">PRE_PROD</option>
          <option *ngIf="currentEnv === 'PRE_PROD'" value="PROD">PROD</option>
        </select>
      </div>

      <!-- Validação para PRE_PROD -> PROD -->
      <div *ngIf="currentEnv === 'PRE_PROD' && promoteTargetEnv === 'PROD' && promoteValidation" class="validation-section">
        <h3>Requisitos para Promoção:</h3>
        <div class="validation-item" [class.valid]="promoteValidation.hasApprovals" [class.invalid]="!promoteValidation.hasApprovals">
          <span class="icon">{{ promoteValidation.hasApprovals ? '✅' : '❌' }}</span>
          <span>Aprovações: {{ promoteValidation.approvalCount }}/1 necessária(s)</span>
        </div>
        <div class="validation-item" [class.valid]="promoteValidation.hasEvidenceUrl" [class.invalid]="!promoteValidation.hasEvidenceUrl">
          <span class="icon">{{ promoteValidation.hasEvidenceUrl ? '✅' : '❌' }}</span>
          <span>Evidence URL: {{ promoteValidation.evidenceUrl ? 'Presente' : 'Faltando' }}</span>
        </div>
        <div class="validation-item" [class.valid]="promoteValidation.hasMinScore" [class.invalid]="!promoteValidation.hasMinScore">
          <span class="icon">{{ promoteValidation.hasMinScore ? '✅' : '❌' }}</span>
          <span>Score: {{ promoteValidation.score }}/{{ promoteValidation.minScore }} mínimo</span>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="promoteRelease()" [disabled]="currentEnv === 'PRE_PROD' && promoteTargetEnv === 'PROD' && promoteValidation && !promoteValidation.canPromote" class="btn-save">Promover</button>
        <button (click)="closePromoteModal()" class="btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>
</div>
