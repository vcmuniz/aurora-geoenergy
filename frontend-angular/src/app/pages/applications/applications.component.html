<div class="applications-container">
  <h1>Aplicações</h1>

  <button (click)="openForm()" *ngIf="canCreate" class="btn-new">+ Nova Aplicação</button>

  <div *ngIf="loading" class="loading">Carregando...</div>

  <table *ngIf="!loading && applications.length > 0" class="table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Equipe</th>
        <th>Repositório</th>
        <th>Criada em</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let app of applications">
        <td>{{ app.name }}</td>
        <td>{{ app.ownerTeam }}</td>
        <td><a *ngIf="app.repoUrl" [href]="app.repoUrl" target="_blank">{{ app.repoUrl }}</a></td>
        <td>{{ app.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <button (click)="viewDetails(app)" class="btn-icon" title="Visualizar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
          </button>
          <button *ngIf="canEdit" (click)="openForm(app)" class="btn-icon" title="Editar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button *ngIf="canDelete" (click)="delete(app.id)" class="btn-icon btn-icon-danger" title="Deletar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="!loading && applications.length === 0" class="empty">
    Nenhuma aplicação encontrada
  </div>

  <div class="pagination">
    <div class="pagination-info">
      <button (click)="previousPage()" [disabled]="!canPrevious" class="btn-nav">← Anterior</button>
      <span class="page-info">Página {{ (skip / limit) + 1 }} de {{ Math.ceil(total / limit) }}</span>
      <button (click)="nextPage()" [disabled]="!canNext" class="btn-nav">Próxima →</button>
    </div>
    <div class="items-per-page">
      <label>Itens por página:</label>
      <select [(ngModel)]="limit" (change)="onLimitChange()" [ngModelOptions]="{updateOn: 'change'}" class="select-limit">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
      </select>
    </div>
  </div>

  <!-- Modal Form -->
  <div *ngIf="showForm" class="modal">
    <div class="modal-content">
      <h2>{{ editingId ? 'Editar' : 'Nova' }} Aplicação</h2>
      <div class="modal-body">
        <form (ngSubmit)="save()">
          <div class="form-group">
            <label>Nome *</label>
            <input [(ngModel)]="formData.name" name="name" type="text" required />
          </div>
          <div class="form-group">
            <label>Equipe *</label>
            <input [(ngModel)]="formData.ownerTeam" name="ownerTeam" type="text" required />
          </div>
          <div class="form-group">
            <label>Repositório URL</label>
            <input [(ngModel)]="formData.repoUrl" name="repoUrl" type="text" />
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn-save">Salvar</button>
            <button type="button" (click)="closeForm()" class="btn-cancel">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Details -->
  <div *ngIf="showDetailsModal" class="modal" (click)="closeDetailsModal()">
    <div class="modal-content modal-details" (click)="$event.stopPropagation()">
      <button (click)="closeDetailsModal()" class="btn-close" title="Fechar">✕</button>
      <h2>Detalhes da Aplicação</h2>
      <div class="modal-body">
        <div *ngIf="selectedApp" class="app-details">
        <div class="detail-section">
          <h3>Informações Gerais</h3>
          <div class="detail-row">
            <span class="detail-label">Nome:</span>
            <span class="detail-value">{{ selectedApp.name }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Equipe:</span>
            <span class="detail-value">{{ selectedApp.ownerTeam }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Repositório:</span>
            <span class="detail-value">
              <a *ngIf="selectedApp.repoUrl" [href]="selectedApp.repoUrl" target="_blank">{{ selectedApp.repoUrl }}</a>
              <span *ngIf="!selectedApp.repoUrl">-</span>
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Criada em:</span>
            <span class="detail-value">{{ selectedApp.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h3>Releases ({{ selectedAppReleases.length }})</h3>
          <div *ngIf="loadingReleases" class="loading-small">Carregando releases...</div>
          
          <div *ngIf="!loadingReleases && selectedAppReleases.length === 0" class="empty-small">
            Nenhuma release encontrada
          </div>

          <div *ngIf="!loadingReleases && selectedAppReleases.length > 0" class="releases-table-container">
            <table class="releases-table">
              <thead>
                <tr>
                  <th>Versão</th>
                  <th>Ambiente</th>
                  <th>Status</th>
                  <th>Score</th>
                  <th>Criada em</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let release of selectedAppReleases">
                  <td><strong>{{ release.version }}</strong></td>
                  <td>
                    <span class="env-badge env-{{ release.env }}">{{ getEnvLabel(release.env) }}</span>
                  </td>
                  <td>
                    <span [class]="'status-badge status-' + release.status">{{ getStatusLabel(release.status) }}</span>
                  </td>
                  <td>{{ release.evidenceScore }}%</td>
                  <td>{{ release.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>